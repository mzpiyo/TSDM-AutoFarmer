name: TSDM Auto Tasks

on:
  schedule:
    - cron: '0 */1 * * *'
    - cron: '0 1 * * *'
  workflow_dispatch:

jobs:
  tsdm-tasks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install httpx beautifulsoup4

      - name: Run Scheduled Task
        env:
          TSDM_COOKIE: ${{ secrets.TSDM_COOKIE }}
        run: |
          if [[ "${{ github.event_name }}" == "schedule" ]]; then
            if [[ "${{ github.event.schedule }}" == "0 1 * * *" ]]; then
              echo "TASK_NAME=每日签到" >> $GITHUB_ENV
              echo "SHOULD_NOTIFY=true" >> $GITHUB_ENV
              python tsdm.py checkin
            elif [[ "${{ github.event.schedule }}" == "0 */1 * * *" ]]; then
              echo "TASK_NAME=自动打工" >> $GITHUB_ENV
              echo "SHOULD_NOTIFY=false" >> $GITHUB_ENV
              python tsdm.py work
            fi
          else
            echo "TASK_NAME=手动执行" >> $GITHUB_ENV
            echo "SHOULD_NOTIFY=true" >> $GITHUB_ENV
            python tsdm.py checkin
            python tsdm.py work
          fi

      - name: Send Gotify Notification on Success
        if: success() && env.SHOULD_NOTIFY == 'true'
        run: |
          curl -X POST "${{ secrets.GOTIFY_URL }}/message?token=${{ secrets.GOTIFY_TOKEN }}" \
          -F "title=天使动漫 ${{ env.TASK_NAME }} 成功 ✅" \
          -F "message=签到任务已完成" \
          -F "priority=5"

      - name: Send Gotify Notification on Failure
        if: failure() && env.SHOULD_NOTIFY == 'true'
        run: |
          curl -X POST "${{ secrets.GOTIFY_URL }}/message?token=${{ secrets.GOTIFY_TOKEN }}" \
          -F "title=天使动漫 ${{ env.TASK_NAME }} 失败 ❌" \
          -F "message=脚本执行出错，请检查 GitHub Actions 日志" \
          -F "priority=8"
